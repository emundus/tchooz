define(["jquery","fab/element"],function(e,t){return window.FbEmundusFileUpload=new Class({Extends:t,initialize:function(e,t){this.setPlugin("emundus_fileupload"),this.parent(e,t),this.watch(t.repeatCounter),document.getElementById("file_"+this.element.id).addEventListener("change",()=>{this.upload(t.repeatCounter)})},watch:function(e){var t=document.querySelector("input#file_"+this.element.id);let i=t.parentElement.parentElement.parentElement,l=t.parentElement,n=new FormData;n.append("uploads",document.getElementById(this.element.id).value),n.append("fnum",this.options.fnum),n.append("element_id",this.options.elid),n.append("attachment_id",this.options.attachment_id),n.append("repeatCounter",e);if(!document.getElementById(this.element.id+"_attachment")){let a=document.createElement("div");a.setAttribute("id",this.element.id+"_attachment"),a.setAttribute("class","em-fileAttachment"),l.appendChild(a)}fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_attachment",{body:n,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{if(e.status){var t=document.querySelector("input#file_"+this.element.id+"_description");if(void 0!==t&&null!=t&&(t.value=""),e.limitObtained){l.querySelector("div.btn-upload").style.display="none",l.querySelector("input#file_"+this.element.id).style.display="none";let n=i.querySelector(".fabrikLabel");n&&(n.style.cursor="default");var a=document.querySelector("div#"+this.element.id+"_description_block");void 0!==a&&null!=a&&(a.style.display="none")}else{l.querySelector("div.btn-upload").style.display="flex",l.querySelector("input#file_"+this.element.id).style.display="block";let s=i.querySelector(".fabrikLabel");s&&(s.style.cursor="pointer")}e.files.forEach(e=>{if(null!==e.repeatCounter){var t=document.querySelector("input#"+this.element.id);""!==t.value?-1===t.value.split(",").indexOf(e.filename)&&(t.value+=",",t.setAttribute("value",t.value+e.filename)):t.setAttribute("value",e.filename)}}),this.loadFilesBlock(e.files)}})},upload:function(e){var t=new FormData,i=document.querySelector("input#file_"+this.element.id);let l=i.parentElement.parentElement.parentElement;var n=i.parentElement,a=document.querySelector("div#"+n.id+" > a.em-deleteFile");t.append("attachId",this.options.attachment_id),t.append("element_id",this.options.elid),t.append("fnum",this.options.fnum),t.append("size",this.options.size),t.append("encrypt",this.options.encrypt),t.append("repeatCounter",e);var s=document.querySelector("input#file_"+this.element.id+"_description");void 0!==s&&null!=s&&t.append("description",s.value);for(var r=[],o=0;o<i.files.length;o++)r=i.files[o],t.append("file[]",r);fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_upload",{body:t,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(e=>{e||Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}});let t=[];for(var s=0;s<e.length;s++){if(e[s].ext&&e[s].size&&!e[s].nbMax){var r=document.querySelector("input#"+this.element.id);""!==r.value&&(r.value+=","),r.setAttribute("value",r.value+e[s].filename),Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SUCCESS"),text:Joomla.JText._("PLG_ELEMENT_FIELD_UPLOAD"),icon:"success",showConfirmButton:!1,timer:1500,customClass:{title:"em-swal-title"}});let o={can_be_viewed:1,can_be_deleted:1,filename:e[s].filename,local_filename:e[s].local_filename,target:e[s].target,description:e[s].description};t.push(o)}if(!e[s].ext&&(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_EXTENSION"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),i.value="",a&&(a.style.display="none")),e[s].encrypt||(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ENCRYPT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),i.value=""),!e[s].size&&(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_SIZE")+e[s].maxSize,customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),i.value="",a&&(a.style.display="none")),e[s].nbMax&&(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_LIMIT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),i.value="",a&&(a.style.display="none")),e[s].noMoreUploads){n.querySelector("div.btn-upload").style.display="none",n.querySelector("input#file_"+this.element.id).style.display="none",l.querySelector(".fabrikLabel").style.cursor="default",i.hide();var d=document.querySelector("div#"+this.element.id+"_description_block");void 0!==d&&null!=d&&(d.style.display="none")}}this.loadFilesBlock(t)})},delete:function(){var e=document.querySelector("input#file_"+this.element.id),t=e.parentElement,i=event.target,l=i.parentElement.parentElement.firstChild.innerText,n=i.parentElement.parentElement.firstChild.href.split("/");n=n[n.length-1],Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SURE"),html:Joomla.JText._("PLG_ELEMENT_FIELD_SURE_TEXT")+"<strong>"+l+"</strong> ?",showCancelButton:!0,reverseButtons:!0,confirmButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CONFIRM"),cancelButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CANCEL"),customClass:{title:"em-swal-title",cancelButton:"em-swal-cancel-button",confirmButton:"em-swal-confirm-button"}}).then(l=>{if(l.value){let a=new FormData;a.append("filename",n),a.append("attachment_id",this.options.attachment_id),a.append("fnum",this.options.fnum),a.append("element_id",this.options.elid),fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_delete",{body:a,method:"post"}).then(e=>{if(e.ok)return e.json()}).then(l=>{if(l.status){t.querySelector("div.btn-upload").style.display="flex",t.querySelector("input#file_"+this.element.id).style.display="block";var a=document.querySelector("div#"+this.element.id+"_description_block");void 0!==a&&null!=a&&(a.style.display="block"),i.parentElement.parentElement.parentElement.remove(),0===t.querySelectorAll(".em-fileAttachment-link").length&&document.querySelector("div#"+this.element.id+"_attachment > .em-fileAttachmentTitle").remove();var s=document.querySelector("input#"+this.element.id);if(""!==s.value){var r=s.value.split(",");l.upload_id?r.splice(r.indexOf(l.upload_id),1):r.splice(r.indexOf(n),1),s.setAttribute("value",r.join(","))}e.value="",Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})}else Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_FAILED"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT_FAILED"),icon:"error",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})})}})},cloned:function(e){var t=document.getElementById(this.element.id).previousElementSibling;t&&(t.id="file_"+this.element.id);var i=document.getElementById(this.element.id).parentElement;i&&(i.id="div_"+this.element.id);var l=document.getElementById(this.element.id).nextElementSibling;l&&(l.id=this.element.id+"_attachment",l.innerHTML=""),document.getElementById("file_"+this.element.id).addEventListener("change",()=>{this.upload(e)}),this.parent(e)},loadFilesBlock:function(e){let t=document.querySelector("input#file_"+this.element.id).parentElement,i=document.getElementById(this.element.id+"_attachment");if(e.length>0){if(!t.querySelector(".em-fileAttachmentTitle")){var l=document.createElement("span");l.setAttribute("class","em-fileAttachmentTitle tw-mt-2"),l.innerText=Joomla.Text._("PLG_ELEMENT_FILEUPLOAD_UPLOADED_FILES"),i.appendChild(l)}for(var n=0;n<e.length;n++){var a=document.createElement("div");a.setAttribute("id",this.element.id+"_attachment"+n);var s=document.createElement("div");if(s.setAttribute("id",this.element.id+"_attachment_link"+n),s.setAttribute("class","em-fileAttachment-link"),document.getElementById(a.id)||(i.appendChild(a),a.appendChild(s)),1==e[n].can_be_viewed){var r=document.createElement("a");r.setAttribute("href",e[n].target),r.setAttribute("target","_blank")}else var r=document.createElement("p");var o=document.createTextNode(e[n].local_filename);if(s.appendChild(r),r.appendChild(o),1==e[n].can_be_deleted){var d=document.createElement("a");d.setAttribute("class","tw-cursor-pointer em-deleteFile tw-ml-2"),d.setAttribute("value",e[n].filename);var m=document.createElement("span");m.setAttribute("class","material-symbols-outlined"),m.setAttribute("style","font-size: 16px"),m.appendChild(document.createTextNode("clear")),d.appendChild(m),s.appendChild(d),document.querySelector("#"+this.element.id+"_attachment_link"+n+" > a.em-deleteFile").addEventListener("click",()=>this.delete())}if(""!==e[n].description){var u=document.createElement("p");u.setAttribute("class","tw-text-sm tw-text-neutral-700"),u.appendChild(document.createTextNode(e[n].description)),a.appendChild(u)}}}}}),window.FbEmundusFileUpload});