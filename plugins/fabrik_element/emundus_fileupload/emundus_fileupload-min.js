define(["jquery","fab/element"],(function(e,t){return window.FbEmundusFileUpload=new Class({Extends:t,initialize:function(e,t){this.setPlugin("emundus_fileupload"),this.parent(e,t),this.watch(t.repeatCounter),document.getElementById("file_"+this.element.id).addEventListener("change",(()=>{this.upload(t.repeatCounter)}))},watch:function(e){var t=document.querySelector("input#file_"+this.element.id);let n=t.parentElement.parentElement.parentElement,l=t.parentElement,i=new FormData;if(i.append("uploads",document.getElementById(this.element.id).value),i.append("fnum",this.options.fnum),i.append("element_id",this.options.elid),i.append("attachment_id",this.options.attachment_id),i.append("repeatCounter",e),!document.getElementById(this.element.id+"_attachment")){let e=document.createElement("div");e.setAttribute("id",this.element.id+"_attachment"),e.setAttribute("class","em-fileAttachment"),l.appendChild(e)}fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_attachment",{body:i,method:"post"}).then((e=>{if(e.ok)return e.json()})).then((e=>{if(e.status){var t=document.querySelector("input#file_"+this.element.id+"_description");if(void 0!==t&&null!=t&&(t.value=""),e.limitObtained){l.querySelector("div.btn-upload").style.display="none",l.querySelector("input#file_"+this.element.id).style.display="none",n.querySelector(".fabrikLabel").style.cursor="default";var i=document.querySelector("div#"+this.element.id+"_description_block");void 0!==i&&null!=i&&(i.style.display="none")}else l.querySelector("div.btn-upload").style.display="flex",l.querySelector("input#file_"+this.element.id).style.display="block",n.querySelector(".fabrikLabel").style.cursor="pointer";e.files.forEach((e=>{if(null!==e.repeatCounter){var t=document.querySelector("input#"+this.element.id);if(""!==t.value)-1===t.value.split(",").indexOf(e.filename)&&(t.value+=",",t.setAttribute("value",t.value+e.filename));else t.setAttribute("value",e.filename)}})),this.loadFilesBlock(e.files)}}))},upload:function(e){var t=new FormData,n=document.querySelector("input#file_"+this.element.id);let l=n.parentElement.parentElement.parentElement;var i=n.parentElement,a=document.querySelector("div#"+i.id+" > a.em-deleteFile");t.append("attachId",this.options.attachment_id),t.append("element_id",this.options.elid),t.append("fnum",this.options.fnum),t.append("size",this.options.size),t.append("encrypt",this.options.encrypt),t.append("repeatCounter",e);var o=document.querySelector("input#file_"+this.element.id+"_description");void 0!==o&&null!=o&&t.append("description",o.value);for(var s=[],r=0;r<n.files.length;r++)s=n.files[r],t.append("file[]",s);fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_upload",{body:t,method:"post"}).then((e=>{if(e.ok)return e.json()})).then((e=>{e||Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}});let t=[];for(var o=0;o<e.length;o++){if(e[o].ext&&e[o].size&&!e[o].nbMax){var s=document.querySelector("input#"+this.element.id);""!==s.value&&(s.value+=","),s.setAttribute("value",s.value+e[o].filename),Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SUCCESS"),text:Joomla.JText._("PLG_ELEMENT_FIELD_UPLOAD"),icon:"success",showConfirmButton:!1,timer:1500,customClass:{title:"em-swal-title"}});let n={can_be_viewed:1,can_be_deleted:1,filename:e[o].filename,local_filename:e[o].local_filename,target:e[o].target,description:e[o].description};t.push(n)}if(e[o].ext||(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_EXTENSION"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[o].encrypt||(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_ENCRYPT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value=""),e[o].size||(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_SIZE")+result[o].maxSize,customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[o].nbMax&&(Swal.fire({icon:"error",title:Joomla.JText._("PLG_ELEMENT_FIELD_ERROR"),text:Joomla.JText._("PLG_ELEMENT_FIELD_LIMIT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}}),n.value="",a&&(a.style.display="none")),e[o].noMoreUploads){i.querySelector("div.btn-upload").style.display="none",i.querySelector("input#file_"+this.element.id).style.display="none",l.querySelector(".fabrikLabel").style.cursor="default",n.hide();var r=document.querySelector("div#"+this.element.id+"_description_block");void 0!==r&&null!=r&&(r.style.display="none")}}this.loadFilesBlock(t)}))},delete:function(){var e=document.querySelector("input#file_"+this.element.id),t=e.parentElement,n=event.target,l=n.parentElement.parentElement.firstChild.innerText,i=n.parentElement.parentElement.firstChild.href.split("/");i=i[i.length-1],Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_SURE"),html:Joomla.JText._("PLG_ELEMENT_FIELD_SURE_TEXT")+"<strong>"+l+"</strong> ?",showCancelButton:!0,reverseButtons:!0,confirmButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CONFIRM"),cancelButtonText:Joomla.JText._("PLG_ELEMENT_FIELD_CANCEL"),customClass:{title:"em-swal-title",cancelButton:"em-swal-cancel-button",confirmButton:"em-swal-confirm-button"}}).then((l=>{if(l.value){const l=new FormData;l.append("filename",i),l.append("attachment_id",this.options.attachment_id),l.append("fnum",this.options.fnum),l.append("element_id",this.options.elid),fetch("index.php?option=com_fabrik&format=raw&task=plugin.pluginAjax&plugin=emundus_fileupload&method=ajax_delete",{body:l,method:"post"}).then((e=>{if(e.ok)return e.json()})).then((l=>{if(l.status){t.querySelector("div.btn-upload").style.display="flex",t.querySelector("input#file_"+this.element.id).style.display="block";var a=document.querySelector("div#"+this.element.id+"_description_block");void 0!==a&&null!=a&&(a.style.display="block"),n.parentElement.parentElement.parentElement.remove(),0===t.querySelectorAll(".em-fileAttachment-link").length&&document.querySelector("div#"+this.element.id+"_attachment > .em-fileAttachmentTitle").remove();var o=document.querySelector("input#"+this.element.id);if(""!==o.value){var s=o.value.split(",");l.upload_id?s.splice(s.indexOf(l.upload_id),1):s.splice(s.indexOf(i),1),o.setAttribute("value",s.join(","))}e.value="",Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT"),customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})}else Swal.fire({title:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_FAILED"),text:Joomla.JText._("PLG_ELEMENT_FIELD_DELETE_TEXT_FAILED"),icon:"error",customClass:{title:"em-swal-title",confirmButton:"em-swal-confirm-button",actions:"em-swal-single-action"}})}))}}))},cloned:function(e){var t=document.getElementById(this.element.id).previousElementSibling;t&&(t.id="file_"+this.element.id);var n=document.getElementById(this.element.id).parentElement;n&&(n.id="div_"+this.element.id);var l=document.getElementById(this.element.id).nextElementSibling;l&&(l.id=this.element.id+"_attachment",l.innerHTML=""),document.getElementById("file_"+this.element.id).addEventListener("change",(()=>{this.upload(e)})),this.parent(e)},loadFilesBlock:function(e){let t=document.querySelector("input#file_"+this.element.id).parentElement,n=document.getElementById(this.element.id+"_attachment");if(e.length>0){if(!t.querySelector(".em-fileAttachmentTitle")){var l=document.createElement("span");l.setAttribute("class","em-fileAttachmentTitle tw-mt-2"),l.innerText=Joomla.Text._("PLG_ELEMENT_FILEUPLOAD_UPLOADED_FILES"),n.appendChild(l)}for(var i=0;i<e.length;i++){var a=document.createElement("div");a.setAttribute("id",this.element.id+"_attachment"+i);var o=document.createElement("div");if(o.setAttribute("id",this.element.id+"_attachment_link"+i),o.setAttribute("class","em-fileAttachment-link"),document.getElementById(a.id)||(n.appendChild(a),a.appendChild(o)),1==e[i].can_be_viewed)(s=document.createElement("a")).setAttribute("href",e[i].target),s.setAttribute("target","_blank");else var s=document.createElement("p");var r=document.createTextNode(e[i].local_filename);if(o.appendChild(s),s.appendChild(r),1==e[i].can_be_deleted){var m=document.createElement("a");m.setAttribute("class","tw-cursor-pointer em-deleteFile tw-ml-2"),m.setAttribute("value",e[i].filename);var d=document.createElement("span");d.setAttribute("class","material-icons-outlined"),d.setAttribute("style","font-size: 16px"),d.appendChild(document.createTextNode("clear")),m.appendChild(d),o.appendChild(m),document.querySelector("#"+this.element.id+"_attachment_link"+i+" > a.em-deleteFile").addEventListener("click",(()=>this.delete()))}if(""!==e[i].description){var u=document.createElement("p");u.setAttribute("class","tw-text-sm tw-text-neutral-700"),u.appendChild(document.createTextNode(e[i].description)),a.appendChild(u)}}}}}),window.FbEmundusFileUpload}));