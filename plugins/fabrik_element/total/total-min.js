/*! Fabrik */
define(["jquery","fab/element"],function(e,t){return window.FbTotal=new Class({Extends:t,observeGroupIds:[],observeElementGroups:[],initialize:function(e,t){this.setPlugin("FbTotal"),this.parent(e,t),this.observeGroupIds=[]},attachedToForm:function(){this.options.observe.each((function(e){this.addObserveEvent(e)}).bind(this)),this.options.totalOnLoad&&this.calc(),Fabrik.addEvent("fabrik.cdd.update",(function(t){t.hasSubElements()&&-1!==e.inArray(t.baseElementId,this.options.observe)&&this.addObserveEvent(t.baseElementId)}).bind(this)),Fabrik.addEvent("fabrik.form.group.duplicate.end",(function(t,s,i){-1!==e.inArray(i,this.observeGroupIds)&&this.calc()}).bind(this)),Fabrik.addEvent("fabrik.form.group.delete.end",(function(t,s,i){-1!==e.inArray(i,this.observeGroupIds)&&this.calc()}).bind(this)),this.parent()},addObserveEvent:function(t){var s,i;""!==t&&(this.form.formElements[t]?this.form.formElements[t].addNewEventAux(this.form.formElements[t].getChangeEvent(),(function(e){this.calc(e)}).bind(this)):this.options.canRepeat?(s=t+"_"+this.options.repeatCounter,this.form.formElements[s]&&this.form.formElements[s].addNewEventAux(this.form.formElements[s].getChangeEvent(),(function(e){this.calc(e)}).bind(this))):this.form.repeatGroupMarkers.each((function(o,n){for(i=0,s="";i<o;i++)s=t+"_"+i,this.form.formElements[s]&&(this.form.formElements[s].addNewEvent(this.form.formElements[s].getChangeEvent(),(function(e){this.calc(e)}).bind(this)),-1===e.inArray(n,this.observeGroupIds)&&(this.observeGroupIds.push(n),this.observeElementGroups[t]=n))}).bind(this)))},calc:function(){var t=this,s=parseFloat(this.options.startValue);switch(this.options.method){case"sum_repeat":e.each(this.options.observe,function(i,o){for(var n=t.form.repeatGroupMarkers[t.observeElementGroups[o]],r=0;r<n;r++){var a=t.form.formElements.get(o+"_"+r);if(a){var h=a.getValue();if(e.isNumeric(h)){var d=t.options.operands[i];switch(h=parseFloat(h),d){case"add":s+=h;break;case"subtract":s-=h;break;case"multiply":s*=h;break;case"divide":0!==h&&(s/=h)}}}}});break;case"sum_multiple":e.each(this.options.observe,function(i,o){t.options.canRepeat&&(o=o+"_"+t.options.repeatCounter);var n=t.form.formElements.get(o);if(n){var r=n.getValue();if(e.isNumeric(r)){var a=t.options.operands[i];switch(r=parseFloat(r),a){case"add":s+=r;break;case"subtract":s-=r;break;case"multiply":s*=r;break;case"divide":0!==r&&(s/=r)}}}})}this.update(s.toFixed(t.options.fixed)),this.element.dispatchEvent(new Event("change"))}}),window.FbTotal});